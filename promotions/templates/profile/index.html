
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Profile</title>
    <!-- Latest compiled and minified CSS of bootstrap 3.3.7 -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <!-- Latest compiled and minified CSS of slickJs 1.8.0 -->
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.0/slick.min.css"/>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.0/slick-theme.css"/>
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script>
    <!-- Latest compiled and minified Jquery library 3.3.1 -->
    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <!-- Latest compiled and minified JavaScript of bootstrap 3.3.7-->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
    <!-- Latest compiled and minified slickJs 1.8.0  -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.0/slick.min.js"></script>
    <!-- Latest compiled and minified slickJs 1.8.0  -->
    <script defer src="https://use.fontawesome.com/releases/v5.0.6/js/all.js"></script>
    <style type="text/css">
        .navbar {
            margin-bottom: 0;
            background-color: #e1e1e1;
            border-bottom: 1px solid #FFFFFF;
        }
        article {
            background-image: -moz-linear-gradient(top, #e5e5e5, white 50%);
            background-image: -webkit-linear-gradient(top, #e5e5e5 0, white 50%);
            background-image: linear, to bottom, #e5e5e5 0, white 50%;
            background-repeat: repeat-x;
        }
        .img-name-container {
            padding-top: 40px;
        }
        .user-name {
            text-align: center;
            width: 140px;
        }
        .user-image {
            width: 140px;
            height: 140px;
            background: #FFF;
            -moz-border-radius: 70px;
            -webkit-border-radius: 70px;
            border-radius: 70px;
            border: 5px solid #333333;
            overflow: hidden;
        }
        .user-image img {
             width: 140px;
        }
        .checkbox-css {
            border: 1px solid black;
            height: 10px;
            width: 10px;
            display: inline-block;
            cursor:pointer;
            margin-right: 5px;
        }
        .check {
          visibility: hidden;
          background: black;
          display: block;
          height: 100%;
        }
        .active {
          visibility: visible;
        }
    </style>
</head>
<body>
    <header>
        <nav class="navbar navbar-default">
            <div class="container-fluid container">
                <div class="navbar-header">
                    <a class="navbar-brand" href="#">
                        User Profile
                    </a>
                </div>
                <ul class="nav navbar-nav navbar-right">
                    <li><a href="https://cpromotion.herokuapp.com/">Regresar a cPromotion</a></li>
                    <li><a id="profile-logout" href="#">Singout <i class="fas fa-sign-out-alt"></i></a></li>
                </ul>
            </div>
        </nav>
    </header>
    <article>
        <div class="container img-name-container">
            <form id="profile-form" action="https://cpromotion.herokuapp.com/edit_profile/" enctype="multipart/form-data" method="POST">
                <div class="row">
                    <div class="col-md-3">
                        <div class="panel panel-default">
                            <div class="panel-body">
                                <div class="user-image">
                                    <img src="" alt="Ejemplo borrar">
                                </div>
                                <div class="user-name">
                                    <h4 id="get-username-profile" >User Name</h4>
                                </div>
                            </div>
                        </div>
                        <div class="panel panel-default">
                            <div class="panel-body">
                                <div class="form-group">
                                    <label for="username">Username:</label>
                                    <input name="username" type="text" class="form-control" id="username-profile" placeholder="Username">
                                </div>
                            </div>
                        </div>
                        <div class="panel panel-default">
                            <div class="panel-body">
                                <div class="form-group" style="overflow: hidden;">
                                    <label for="uploadImage">Subir imagen:</label>
                                    <input name="image" type="file" id="image-profile">
                                    <p class="help-block">Example block-level help text here.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-5">
                        <div class="panel panel-default">
                            <div class="panel-body">
                                <div class="form-group">
                                    <label for="nombre">Nombre:</label>
                                    <input name="first_name" type="text" class="form-control" id="name-profile" placeholder="Nombre del usuario">
                                </div>
                                <div class="form-group">
                                    <label for="apellido">Apellido:</label>
                                    <input name="last_name" type="text" class="form-control" id="last-name-profile" placeholder="Apellidos del usuario">
                                </div>
                                <div class="form-group">
                                    <label for="email">Email:</label>
                                    <input name="email" type="email" class="form-control" id="email-profile" placeholder="usuario@correo.com">
                                </div>
                                <div class="form-group">
                                    <label for="pais">Pais:</label>
                                    <input name="country" type="text" class="form-control" id="country-profile" placeholder="Colombia">
                                </div>
                                <div class="form-group">
                                    <label for="ciudad">Ciudad:</label>
                                    <input name="city" type="text" class="form-control" id="city-profile" placeholder="Ciudad">
                                </div>
                                <div class="form-group">
                                    <label for="direccion">Dirección:</label>
                                    <input name="address" type="text" class="form-control" id="address-profile" placeholder="Calle 42 No. 5-24">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="panel panel-default">
                            <div class="panel-body">
                                <div class="form-group">
                                    <label for="password">Contraseña:</label>
                                    <input name="password" type="password" class="form-control" id="password-profile" placeholder="Password" disabled>
                                </div>
                                <div class="form-group">
                                    <label for="confirmarContrasena">Confirmar Contraseña:</label>
                                    <input name="confirm_password" type="password" class="form-control" id="confirm-password-profile" placeholder="Password" disabled>
                                </div>
                            </div>
                        </div>
                        <div class="panel panel-default">
                            <div class="panel-body">
                                <div class="form-group">
                                    <label for="categorias">Categorías:</label>
                                    <hr>
                                    <div id="category-profile" class="row"></div>
                                    <input name="category" id="input-category" type="text" hidden>
                                </div>
                            </div>
                        </div>
                        <div class="panel panel-default">
                            <div class="panel-body alert-register">
                                <div class="row">
                                    <div class="col-md-offset-4 col-md-8" style="text-align: right;">
                                        <button id="btn-edit_information" type="button" class="btn btn-success"><i class="fas fa-edit"></i> Editar</button>
                                        <button id="btn-edit-profile" type="submit" class="btn btn-danger"><i class="fas fa-save" disabled ></i> Enviar</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </article>
    <footer></footer>
    <script type="text/javascript">
        $(document).ready(function(){
            $("#btn-edit-profile").prop("disabled", true);
            // ==============================================================================================
            // User Categories controller
            // ==============================================================================================
            $("#category-profile").on("click", ".checkbox-css", function(e){
               e.preventDefault();
               if($(this).children().eq(0).css("visibility") === "hidden"){
                   $(this).children().eq(0).css("visibility", "visible");
               } else {
                   $(this).children().eq(0).css("visibility", "hidden");
               }
               var getChecked = $(".check-container");
               var getTextChecked = "";
               for(var ck=0; ck<getChecked.length; ck++){
                   var visible = getChecked.eq(ck).children().eq(0).children().eq(0);
                   if(visible.css("visibility") === "visible") {
                       if(getTextChecked != ""){
                           getTextChecked = getTextChecked + "-" + getChecked.eq(ck).children().eq(1).html();
                       } else{
                           getTextChecked = getChecked.eq(ck).children().eq(1).html();
                       }
                   }
               }
               $("#input-category").val(getTextChecked);
            });
            // ==============================================================================================
            // Is auth controller
            // ==============================================================================================
            (function (){
                $.getJSON("https://cpromotion.herokuapp.com/logged_users/").done(function(data){
                    if( data.message === "logged"){
                        $("#li-login, #li-register").css("display", "none");
                        $("#li-welcome, #li-username").css("display", "block");
                        $("#get-username-profile").html("").append(data.username).prop("disabled", true);
                        $("#email-profile").val(data.email).prop("disabled", true);
                        $("#name-profile").val(data.first_name).prop("disabled", true);
                        $("#last-name-profile").val(data.last_name).prop("disabled", true);
                        $("#username-profile").val(data.username).prop("disabled", true);
                    } else {
                        $("#li-login, #li-register").css("display", "block");
                        $("#li-welcome, #li-username").css("display", "none");
                    }
                }).fail(function(jqxhr, textStatus, error) {
                    var err = textStatus + ", " + error;
                });
            })();
            // ==============================================================================================
            // Send value of inpunt user information
            // ==============================================================================================
            $.getJSON("https://cpromotion.herokuapp.com/user_information/").done(function(data){
                    $("#country-profile").val(data[0].fields.country).prop("disabled", true);
                    $("#city-profile").val(data[0].fields.city).prop("disabled", true);
                    $("#address-profile").val(data[0].fields.address).prop("disabled", true);
                    $(".user-image img").attr("src", "../"+data[0].fields.image );
                    $("#input-category").val(data[0].fields.category);
                    var getCategory = data[0].fields.category,
                        splitCategory = getCategory.split("-");
                    
                    setTimeout(function(){
                        var checkCategories = $(".check-container");
                
                        for(var ca=0; ca<checkCategories.length; ca++){
                            var checkCategory = checkCategories.eq(ca).children().eq(1);
                            for( var sp=0; sp< splitCategory.length; sp++){
                                if(checkCategory.html() === splitCategory[sp] ){
                                    checkCategories.eq(ca).children().eq(0).children().eq(0).css("visibility", "visible");
                                }
                            }

                        }
                    }, 800);

            }).fail();

            $("#btn-edit_information").on("click", function(e){
               e.preventDefault();
               var getInputs = $("form").find("input");
               for(var ip=0; ip<getInputs.length;ip++) {
                   if (getInputs.eq(ip).attr("id") === "password-profile" || getInputs.eq(ip).attr("id") === "confirm-password-profile") {
                       getInputs.eq(ip).prop("disabled", true);
                   } else {
                       getInputs.eq(ip).prop("disabled", false);
                   }
               }

               $(this).prop("disabled", true);
               $("#btn-edit-profile").prop("disabled", false);
            });
            // ==============================================================================================
            // Categories controller
            // ==============================================================================================
            var categorias;
            var dataCategory = function(data){
               categorias=data;
               for(var ca=0; ca<categorias.length; ca++){
                    $("#category-profile").append(
                        "<div class='col-md-6 check-container'>" +
                           "<div class='checkbox-css'>" +
                                "<i class='check'></i>" +
                            "</div>" +
                            "<span class='check-names'>"+ categorias[ca].fields.name +"</span>" +
                        "</div>"
                    )
                }
            };
            $.getJSON("https://cpromotion.herokuapp.com/list_category").done(function(data){
                dataCategory(data);
            });
            // ==============================================================================================
            // Edit profile controller
            // ==============================================================================================
            $("#btn-edit-profile").on("click", function(e){
                $("#btn-edit-profile").prop("disabled", true);
                $("#btn-edit_information").prop("disabled", false);

                var formData = new FormData($("#profile-form")[0]);
                e.preventDefault();
                //Openiendo codigo csrf para el registro
                var csrftoken = Cookies.get('csrftoken');
                function csrfSafeMethod(method) {
                    // these HTTP methods do not require CSRF protection
                    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
                }
                $.ajaxSetup({
                    beforeSend: function(xhr, settings) {
                        if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                            xhr.setRequestHeader("X-CSRFToken", csrftoken);
                        }
                    }
                });
                $.ajax({
                    type: "POST",
                    url: "https://cpromotion.herokuapp.com/edit_profile/",
                    data: formData,
                    cache: false,
                    contentType: false,
                    processData: false,
                    success: function(data){
                        console.log(data);
                        $(".alert-register").append(
                            "<div class='alert alert-success' role='alert' style='margin-top: 15px;' >"+ data.message + " éxito, la pagina se actulizará para mostrrar cambios" + "</div>"
                        );
                        setTimeout(function(){
                            window.location.href = "https://cpromotion.herokuapp.com/profile/";
                        }, 3000)

                    },
                    failure: function(errMessage){
                        console.log("Error enviando datos de registro");
                    }
                });
            });
            // ==============================================================================================
            // Logout controller
            // ==============================================================================================
            $("#profile-logout").on("click", function(e){
               e.preventDefault();
               $.getJSON("https://cpromotion.herokuapp.com/logout_users/").done(function(data){
                    if( data.message === "ok"){
                        window.location.href = "https://cpromotion.herokuapp.com/";
                    } else {
                        console.log("Error al cerrar sesion");
                    }
               }).fail(function(jqxhr, textStatus, error) {
                    var err = textStatus + ", " + error;
                });
            });
        });

    </script>
</body>
</html>
